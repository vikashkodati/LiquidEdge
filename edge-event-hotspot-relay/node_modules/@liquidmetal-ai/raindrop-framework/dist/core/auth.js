import { NoWay, decodeJwt } from '@liquidmetal-ai/noway';
/**
 * Attempts to validate and decode JWT from Authorization header.
 *
 * Trusted issuers are specified via LM_AUTH_ALLOWED_ISSUERS (comma-separated list).
 * JWKS origin validation is performed against LM_AUTH_ALLOWED_ORIGINS (comma-separated list).
 *
 * Populates env.jwt on successful verification. Always allows request to continue.
 * @param request The incoming request object.
 * @param env The environment object containing auth configuration and mem (a KvCache instance).
 * @returns Always returns true to allow request to continue.
 */
export const verifyIssuer = async (request, env) => {
    const authHeader = request.headers.get('Authorization');
    if (authHeader && authHeader.startsWith('Bearer ')) {
        const token = authHeader.substring(7);
        if (token) {
            try {
                // Parse comma-separated allowed origins and issuers
                const allowedOrigins = env.LM_AUTH_ALLOWED_ORIGINS.split(',').map(o => o.trim());
                const allowedIssuers = env.LM_AUTH_ALLOWED_ISSUERS.split(',').map(i => i.trim());
                const noWay = new NoWay({
                    kvCache: env.mem,
                    originValidator: (url) => {
                        try {
                            const hostname = new URL(url).hostname;
                            return allowedOrigins.includes(hostname);
                        }
                        catch {
                            return false;
                        }
                    },
                    defaultTtl: 300
                });
                // Verify the JWT against any of the trusted issuers
                const jwt = await noWay.verifyJWTWithJWKS(token, { issuer: allowedIssuers });
                env.jwt = jwt;
            }
            catch (error) {
                // Log verification failure but don't block request
                if (env.logger) {
                    const decoded = decodeJwt(token);
                    const actualIssuer = decoded.iss;
                    const allowedIssuers = env.LM_AUTH_ALLOWED_ISSUERS.split(',').map(i => i.trim());
                    const originalError = error instanceof Error ? error.message : String(error);
                    env.logger.error(`JWT verification failed. Actual issuer: "${actualIssuer}". Expected one of: ${JSON.stringify(allowedIssuers)}. Original error: ${originalError}`);
                }
            }
        }
    }
    return true;
};
/**
 * Default authorizer that requires authentication.
 * Checks if a valid JWT exists in env.jwt (populated by verifyIssuer).
 * @param _request The incoming request object (not used in this function).
 * @param env The environment object containing the decoded JWT in env.jwt.
 * @returns True if authenticated (JWT exists), false otherwise.
 */
export const requireAuthenticated = async (_request, env) => {
    return !!env.jwt;
};
